import requests
import pandas as pd
from datetime import datetime
import boto3
from io import StringIO
import os

import re
import time
import random
import requests
from bs4 import BeautifulSoup

# get environmental variables
AWS_ACCESS_KEY_ID = os.environ['AWS_ACCESS_KEY_ID']
AWS_SECRET_ACCESS_KEY = os.environ['AWS_SECRET_ACCESS_KEY']

# get current date and datetime
current_datetime = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
current_datetime_label = datetime.now().strftime('%Y-%m-%d-%H-%M-%S')

WANTED = [
    "Parcel NUMBER",
    "S/T/R",
    "PROPERTY DESCRIPTION",
    "SUBDIVISION",
    "UNIT",
    "BLOCK",
    "LOT",
    "PHASE",
    "CABINET",
    "SLIDE",
    "PRIMARY OWNER",
    "NAME 2",
    "IN C/O",
    "TAX BILL MAILING ADDRESS",
    "PROPERTY ADDRESS(LOCATION)",
    "PARCEL ALERT LIST",
    "DATE OF RECORDING",
    "SALE AMOUNT",
]

def _norm(s: str) -> str:
    s = (s or "").strip().upper()
    s = re.sub(r"\s+", " ", s)
    s = s.replace(" (", "(").replace("( ", "(")
    return s

def _extract_selected_from_html(html: str) -> dict:
    soup = BeautifulSoup(html, "html.parser")
    lines = [x.strip() for x in soup.get_text("\n").split("\n")]
    lines = [x for x in lines if x]

    wanted_norm = {_norm(x): x for x in WANTED}
    out = {k: None for k in WANTED}

    i = 0
    while i < len(lines):
        key_norm = _norm(lines[i])
        if key_norm in wanted_norm:
            canonical = wanted_norm[key_norm]
            j = i + 1
            while j < len(lines) and not lines[j].strip():
                j += 1
            out[canonical] = lines[j].strip() if j < len(lines) else None
            i = j + 1
        else:
            i += 1

    return out

def fetch_one(parcel_id, session: requests.Session, timeout=30) -> dict:
    url = f"https://app1.pinal.gov/Search/Parcel-Details.aspx?parcel_ID={parcel_id}"
    r = session.get(url, timeout=timeout)
    r.raise_for_status()
    fields = _extract_selected_from_html(r.text)
    fields["parcel_id"] = str(parcel_id)   # the query id you passed
    fields["source_url"] = url
    return fields

def fetch_many(parcel_ids, *, sleep_range=(0.15, 0.45), timeout=30, max_errors=25):
    """
    Returns:
      wide_df: one row per parcel_id, columns are WANTED + parcel_id + source_url
      errors_df: rows for failures (parcel_id, error)
    """
    rows = []
    errors = []

    with requests.Session() as s:
        s.headers.update({"User-Agent": "Mozilla/5.0"})

        for idx, pid in enumerate(parcel_ids, start=1):
            try:
                rows.append(fetch_one(pid, s, timeout=timeout))
            except Exception as e:
                errors.append({"parcel_id": str(pid), "error": repr(e)})
                if len(errors) >= max_errors:
                    break
            # be polite to the server
            time.sleep(random.uniform(*sleep_range))

    wide_df = pd.DataFrame(rows)

    # Ensure consistent column order
    col_order = ["parcel_id"] + WANTED + ["source_url"]
    for c in col_order:
        if c not in wide_df.columns:
            wide_df[c] = None
    wide_df = wide_df[col_order].sort_values("parcel_id").reset_index(drop=True)

    errors_df = pd.DataFrame(errors)
    return wide_df, errors_df

# ---- Example usage ----
parcel_ids = [
509843490,
509843500,
509843510,
509843520,
509843530,
509843540,
509843550,
509843560,
509843570,
509843580,
509843590,
509843600,
509843610,
509843620,
509843630,
509843640,
509843650,
509843660,
509843670,
509843680,
509843690,
509843700,
509843710,
509843720,
509843730,
509843740,
509843750,
509843760,
509843770,
509843780,
509843790,
509843800,
509843810,
509843820,
509843830,
509843840,
509843850,
509843860,
509843870,
509843880,
509843890,
509843900,
509843910,
509843920,
509843930,
509843940,
509843950,
509843960,
509843970,
509843980,
509843990,
509844000,
509844010,
509844020,
509844030,
509844040,
509844050,
509844060,
509844070,
509844080,
509844090,
509844100,
509844110,
509844120,
509844130,
509844140,
509844150,
509844160,
509844170,
509844180,
509844190,
509844200,
509844210,
509844220,
509844230,
509844240,
509844250,
509844260,
509844270,
509844280,
509844290,
509844300,
509844310,
509844320,
509844330,
509844340,
509844350,
509844360,
509844370,
509844380,
509844390,
509844400,
509844410,
509844420,
509844430,
509844440,
509844450,
509844460,
509844470,
509844480,
509844490,
509844500,
509844510,
509844520,
509844530,
509844540,
509844550,
509844560,
509844570,
509844580,
509844590,
509844600,
509844610,
509844620,
509844630,
509844640,
509844650,
509844660,
509844670,
509844680,
509844690,
509844700,
509844710,
509844720,
509844730,
509844740,
509844750,
509844760,
509844760,
509844760,
509844770,
509844780,
509844790,
509844800,
509844810,
509844820,
509844830,
509844840,
509844850,
509844860,
509844870,
509844880,
509844890,
509844900,
509844910,
509844920,
509844930,
509844940,
509844950,
509844960,
509844970,
509844980,
509844990,
509845000,
509845010,
509845020,
509845030,
509845040,
509845050,
509845060,
509845070,
509845080,
509845090,
509845100,
509845110,
509845120,
509845130,
509845140,
509845150,
509845160,
509845170,
509845180,
509845190,
509845200,
509845210,
509845210,
509845220,
509845230,
509845240,
509845250,
509845260,
509845270,
509845280,
509845290,
509845300,
509845310,
509845320,
509845330,
509845340,
509845350,
509845360,
509845370,
509845380,
509845390,
509845400,
509845410,
509845420,
509845430,
509845440,
509845450,
509845460,
509845470,
509845480,
509845490,
509845500,
509845510,
509845520,
509845530,
509845540,
509845550,
509845560,
509845570,
509845580,
509845590,
509845600,
509845610,
509845620,
509845630,
509845640,
509845650,
509845660,
509845670,
509845680,
509845690,
509845700,
509845710,
509845720,
509845730,
509845740,
509845750,
509845760,
509845770,
509845780,
509845790,
509845800,
509845810,
509845820,
509845830,
509845840,
509845850,
509845860,
509845870,
509845880,
509845890,
509845900,
509845910,
509845920,
509845930,
509845940,
509845950,
509845960,
509845970,
509845980,
509845990,
509846000,
509846010,
509846020,
509846030,
509846040,
509846050,
509846060,
509846070,
509846080,
509846090,
509846100,
509846110,
509846120,
509846130,
509846140,
509846150,
509846160,
509846170,
509846180,
509846190,
509846200,
509846210,
509846220,
509846230,
509846240,
509846250,
509846260,
509846270,
509846290,
509846300,
509846310,
509846320,
509846330,
509846340,
509846350,
509846360,
509846370,
509846380,
509846390,
509846400,
509846410,
509846420,
509846430,
509846440,
509846450,
509846460,
509846470,
509846480,
509846490,
509846500,
509846510,
509846520,
509846530,
509846540,
509846550,
509846560,
509846570,
509846580,
509846590,
509846600,
509846610,
509846620,
509846630,
509846640,
509846650,
509846660,
509846670,
509846680,
509846690,
509846700,
509846710,
509846720,
509846730,
509846740,
509846740,
509846750,
509846760,
509846770,
509846780,
509846790,
509846800,
509846810,
509846820,
509846830,
509846840,
509846850,
509846860,
509846870,
509846880,
509846890,
509846900,
509846910,
509846920,
509846930,
509846940,
509846950,
509846960,
509846970,
509846980,
509846990,
509847000,
509847010,
509847020,
509847030,
509847040,
509847050,
509847060,
509847070,
509847080,
509847090,
509847100,
509847110,
509847120,
509847130,
509847140,
509847150,
509847160,
509847170,
509847180,
509847190,
509847200,
509847210,
509847220,
509847230,
509847240,
509847250,
509847260,
509847270,
509847280,
509847290,
509847300,
509847310,
509847320,
509847330,
509847340,
509847350,
509847360,
509847370,
509847380,
509847390,
509847400,
509847410,
509847420,
509847430,
509847440,
509847450,
509847460,
509847470,
509847480,
509847490,
509847500,
509847510,
509847520,
509847530,
509847540,
509847550,
509847560,
509847570,
509847580,
509847590,
509847600,
509847610,
509847620,
509847630,
509847640,
509847650,
509847660,
509847670,
509847680,
509847690,
509847700,
509847710,
509847720,
509847730,
509847740,
509847750,
509847760,
509847770,
509847780,
509847790,
509847800,
509847810,
509847820,
509847830,
509847840,
509847850,
509847860,
509847870,
509847880,
509847890,
509847900,
509847910,
509847920,
509847930,
509847940,
509847950,
509847960,
509847970,
509847980,
509847990,
509848000,
509848010,
509848020,
509848030,
509848040,
509848050,
509848060,
509848070,
509848080,
509848090,
509848100,
509848110,
509848120,
509848130,
509848140,
509848150,
509848160,
509848170,
509848180,
509848190,
509848200,
509848210,
509848220,
509848230,
509848240,
509848250,
509848260,
509848270,
509848280,
509848290,
509848300,
509848310,
509848320,
509848330,
509848340,
509848350,
509848360,
509848370,
509848380,
509848390,
509848400,
509848410,
509848420,
509848430,
509848440,
509848450,
509848460,
509848470,
509848480,
509848490,
509848500,
509848510,
509848520,
509848530,
509848540,
509848550,
509848560,
509848570,
509848580,
509848590,
509848600,
509848610,
509848620,
509848630,
509848640,
509848650,
509848660,
509848670,
509848680,
509848690,
509848700,
509848710,
509848720,
509848730,
509848740
]

wide_df, errors_df = fetch_many(parcel_ids)

# copy to s3
s3 = boto3.client('s3', aws_access_key_id=AWS_ACCESS_KEY_ID, aws_secret_access_key=AWS_SECRET_ACCESS_KEY)
def copy_to_s3(client, df, bucket, filepath):
    csv_buf = StringIO()
    df.to_csv(csv_buf, header=True, index=False)
    csv_buf.seek(0)
    client.put_object(Bucket=bucket, Body=csv_buf.getvalue(), Key=filepath)
    print(f'Copy {df.shape[0]} rows to S3 Bucket {bucket} at {filepath}, Done!')

file_path = 'pinal-county-parcels/gila-buttes-parcels-' + current_datetime_label + '.csv'
copy_to_s3(client=s3, df=wide_df, bucket='egw-data-dumps', filepath=file_path)
